<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orders Management - Admin - Import From Nepal</title>
    <script src="https://cdn.tailwindcss.com"></script>    <script src="api-config.js"></script>    <style>
        /* All Tailwind classes are now in the HTML. No custom CSS needed. */
    </style>
</head>
<body class="bg-gray-100">
    <!-- Top Navigation -->
    <nav class="bg-gray-900 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-orange-400">
                    Import From Nepal
                </h1>
                <span class="text-gray-400 text-sm">Admin Panel</span>
            </div>
            <div class="flex items-center gap-4">
                <span id="admin-user" class="text-gray-400">Admin</span>
                <a href="/" class="text-gray-400 hover:text-white transition">View Site</a>
                <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded transition">
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="flex">
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-800 min-h-screen shadow-lg">
            <nav class="pt-4">
                <a href="dashboard.html" class="sidebar-link dashboard-link">
                    <span>üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="products.html" class="sidebar-link products-link">
                    <span>üì¶</span>
                    <span>Products</span>
                </a>
                <a href="categories.html" class="sidebar-link categories-link">
                    <span>üìÇ</span>
                    <span>Categories</span>
                </a>
                <a href="orders.html" class="sidebar-link orders-link active">
                    <span>üõí</span>
                    <span>Orders</span>
                </a>
                <a href="content.html" class="sidebar-link content-link">
                    <span>‚úèÔ∏è</span>
                    <span>Content</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8">
            <h2 class="text-3xl font-bold mb-8 text-gray-800">Orders Management</h2>

            <!-- Filters -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Filter by Status</label>
                        <select id="status-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="processing">Processing</option>
                            <option value="shipped">Shipped</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Search by Email</label>
                        <input type="text" id="email-search" placeholder="customer@email.com" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Sort By</label>
                        <select id="sort-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="highest">Highest Amount</option>
                            <option value="lowest">Lowest Amount</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">&nbsp;</label>
                        <button onclick="applyFilters()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                            Apply Filters
                        </button>
                    </div>
                </div>
            </div>

            <!-- Orders Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-100 border-b-2 border-gray-200">
                            <tr>
                                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Order ID</th>
                                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Customer</th>
                                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Email</th>
                                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Total</th>
                                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Status</th>
                                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Date</th>
                                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table" class="divide-y">
                            <tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Order Detail Modal -->
    <div id="order-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full my-auto">
            <div class="bg-gray-50 px-6 py-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Order Details</h3>
                <button onclick="closeOrderModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="modal-content" class="p-6 max-h-96 overflow-y-auto">
                <!-- Content loaded dynamically -->
            </div>
            <div class="px-6 py-4 border-t bg-gray-50 flex gap-3">
                <button onclick="closeOrderModal()" class="flex-1 px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg transition">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div id="status-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="px-6 py-4 border-b">
                <h3 class="text-xl font-bold">Update Order Status</h3>
            </div>
            <div class="p-6">
                <p class="text-gray-600 mb-4">Order ID: <span id="order-id-value" class="font-mono font-bold"></span></p>
                <label class="block text-sm font-semibold text-gray-700 mb-2">New Status</label>
                <select id="new-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                    <option value="pending">Pending</option>
                    <option value="processing">Processing</option>
                    <option value="shipped">Shipped</option>
                    <option value="delivered">Delivered</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
            <div class="px-6 py-4 border-t bg-gray-50 flex gap-3">
                <button onclick="closeStatusModal()" class="flex-1 px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg transition font-medium">
                    Cancel
                </button>
                <button onclick="saveStatusUpdate()" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition font-medium">
                    Update Status
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

    <script>
        let allOrders = [];
        let filteredOrders = [];
        let currentOrderId = null;

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `px-4 py-3 rounded shadow-lg text-white ${
                type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'
            }`;
            toast.textContent = message;
            document.getElementById('toast-container').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('admin_token');
                window.location.href = '/admin/login.html';
            }
        }

        function getStatusClass(status) {
            return `status-${status}`;
        }

        async function loadOrders() {
            try {
                const response = await fetch(apiUrl('/api/admin/orders'));
                if (!response.ok) throw new Error('Failed to fetch orders');
                allOrders = await response.json();
                applyFilters();
            } catch (error) {
                console.error('Error loading orders:', error);
                showToast('Error loading orders', 'error');
                document.getElementById('orders-table').innerHTML = `
                    <tr><td colspan="7" class="px-6 py-8 text-center text-red-500">Error loading orders</td></tr>
                `;
            }
        }

        function applyFilters() {
            let filtered = [...allOrders];
            
            // Status filter
            const statusFilter = document.getElementById('status-filter').value;
            if (statusFilter) {
                filtered = filtered.filter(o => o.status === statusFilter);
            }

            // Email search
            const emailSearch = document.getElementById('email-search').value.toLowerCase();
            if (emailSearch) {
                filtered = filtered.filter(o => 
                    (o.customer_email || '').toLowerCase().includes(emailSearch) ||
                    (o.customer_name || '').toLowerCase().includes(emailSearch)
                );
            }

            // Sort
            const sortFilter = document.getElementById('sort-filter').value;
            if (sortFilter === 'newest') {
                filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            } else if (sortFilter === 'oldest') {
                filtered.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            } else if (sortFilter === 'highest') {
                filtered.sort((a, b) => (b.total_amount || 0) - (a.total_amount || 0));
            } else if (sortFilter === 'lowest') {
                filtered.sort((a, b) => (a.total_amount || 0) - (b.total_amount || 0));
            }

            filteredOrders = filtered;
            renderOrders();
        }

        function renderOrders() {
            const tbody = document.getElementById('orders-table');
            
            if (filteredOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">No orders found</td></tr>';
                return;
            }

            tbody.innerHTML = filteredOrders.map(order => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 text-sm font-mono">#${String(order.id).substring(0, 8)}</td>
                    <td class="px-6 py-4 text-sm">${order.customer_name || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm">${order.customer_email || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm font-semibold">$${(order.total_amount || 0).toFixed(2)}</td>
                    <td class="px-6 py-4 text-sm">
                        <span class="status-badge ${getStatusClass(order.status || 'pending')}">
                            ${(order.status || 'pending').toUpperCase()}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm">${new Date(order.created_at).toLocaleDateString()}</td>
                    <td class="px-6 py-4 text-sm flex gap-2">
                        <button onclick="viewOrderDetails('${order.id}')" class="text-blue-600 hover:text-blue-800 font-semibold">View</button>
                        <button onclick="openStatusModal('${order.id}')" class="text-orange-600 hover:text-orange-800 font-semibold">Update</button>
                    </td>
                </tr>
            `).join('');
        }

        function viewOrderDetails(orderId) {
            const order = allOrders.find(o => String(o.id) === String(orderId));
            if (!order) {
                console.error('Order not found:', orderId, 'Available IDs:', allOrders.map(o => o.id));
                showToast('Order not found', 'error');
                return;
            }

            // Parse items from JSON string
            let items = [];
            try {
                items = typeof order.items === 'string' ? JSON.parse(order.items) : order.items;
            } catch (e) {
                console.error('Error parsing items:', e);
                items = [];
            }

            const itemsHtml = Array.isArray(items) && items.length > 0
                ? items.map(item => `
                    <div class="flex justify-between mb-2">
                        <span>${escapeHtml(item.name || 'Unknown')} x${item.quantity || 1}</span>
                        <span>$${(item.price || 0).toFixed(2)}</span>
                    </div>
                `).join('')
                : '<p class="text-gray-500">No items data</p>';

            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-2">Customer Information</h4>
                        <p><strong>Name:</strong> ${escapeHtml(order.customer_name || 'N/A')}</p>
                        <p><strong>Email:</strong> ${escapeHtml(order.customer_email || 'N/A')}</p>
                        <p><strong>Phone:</strong> ${escapeHtml(order.customer_phone || 'N/A')}</p>
                        <p><strong>Country:</strong> ${escapeHtml(order.customer_country || 'N/A')}</p>
                        <p><strong>Address:</strong> ${escapeHtml(order.customer_address || 'N/A')}</p>
                        <p><strong>City:</strong> ${escapeHtml(order.customer_city || 'N/A')}, ${escapeHtml(order.customer_state || 'N/A')} ${escapeHtml(order.customer_zip || '')}</p>
                    </div>
                    <div class="border-t pt-4">
                        <h4 class="font-semibold text-gray-700 mb-2">Order Items</h4>
                        ${itemsHtml}
                    </div>
                    <div class="border-t pt-4">
                        <h4 class="font-semibold text-gray-700 mb-2">Order Summary</h4>
                        <p><strong>Subtotal:</strong> $${(order.subtotal || 0).toFixed(2)}</p>
                        <p><strong>Shipping:</strong> $${(order.shipping_cost || 0).toFixed(2)}</p>
                        <p><strong>Tax:</strong> $${(order.tax || 0).toFixed(2)}</p>
                        <p class="border-t pt-2"><strong>Total:</strong> $${(order.total_amount || 0).toFixed(2)}</p>
                    </div>
                    ${order.special_requests ? `<div class="border-t pt-4">
                        <h4 class="font-semibold text-gray-700 mb-2">Special Requests</h4>
                        <p>${escapeHtml(order.special_requests)}</p>
                    </div>` : ''}
                    <div class="border-t pt-4">
                        <p><strong>Order Date:</strong> ${new Date(order.created_at).toLocaleString()}</p>
                        <p><strong>Status:</strong> <span class="status-badge ${getStatusClass(order.status || 'pending')}">${(order.status || 'pending').toUpperCase()}</span></p>
                    </div>
                </div>
            `;
            const modal = document.getElementById('order-modal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        function closeOrderModal() {
            const modal = document.getElementById('order-modal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
        }

        function openStatusModal(orderId) {
            currentOrderId = orderId;
            const order = allOrders.find(o => String(o.id) === String(orderId));
            if (!order) {
                console.error('Order not found:', orderId, 'Available IDs:', allOrders.map(o => o.id));
                showToast('Order not found', 'error');
                return;
            }

            document.getElementById('order-id-value').textContent = String(orderId).substring(0, 8);
            document.getElementById('new-status').value = order.status || 'pending';
            const modal = document.getElementById('status-modal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        function closeStatusModal() {
            const modal = document.getElementById('status-modal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
            currentOrderId = null;
        }

        async function saveStatusUpdate() {
            if (!currentOrderId) {
                showToast('No order selected', 'error');
                return;
            }

            const newStatus = document.getElementById('new-status').value;
            
            try {
                const response = await fetch(apiUrl('/api/admin/orders'), {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: String(currentOrderId), status: newStatus })
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`Failed to update order: ${response.statusText} - ${errorData}`);
                }

                const updatedOrder = await response.json();
                
                // Update local order
                const order = allOrders.find(o => String(o.id) === String(currentOrderId));
                if (order) {
                    order.status = newStatus;
                }

                closeStatusModal();
                renderOrders();
                showToast('Order status updated successfully');
            } catch (error) {
                console.error('Error updating status:', error);
                showToast('Error updating order status: ' + error.message, 'error');
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        window.addEventListener('DOMContentLoaded', loadOrders);

        // Event listeners
        document.getElementById('status-filter').addEventListener('change', applyFilters);
        document.getElementById('email-search').addEventListener('keyup', applyFilters);
        document.getElementById('sort-filter').addEventListener('change', applyFilters);
    </script>
</body>
</html>