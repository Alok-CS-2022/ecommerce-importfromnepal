<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Categories Management - Admin - Import From Nepal</title>
    <script src="https://cdn.tailwindcss.com"></script>    <script src="api-config.js"></script>    <style>
        .sidebar-link {
            @apply flex items-center gap-3 px-4 py-3 text-gray-300 hover:bg-gray-700 transition;
        }
        .sidebar-link.active {
            @apply bg-blue-600 text-white border-l-4 border-orange-500;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Top Navigation -->
    <nav class="bg-gray-900 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-orange-400">
                    Import From Nepal
                </h1>
                <span class="text-gray-400 text-sm">Admin Panel</span>
            </div>
            <div class="flex items-center gap-4">
                <span id="admin-user" class="text-gray-400">Admin</span>
                <a href="/" class="text-gray-400 hover:text-white transition">View Site</a>
                <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded transition">
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="flex">
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-800 min-h-screen shadow-lg">
            <nav class="pt-4">
                <a href="dashboard.html" class="sidebar-link dashboard-link">
                    <span>üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="products.html" class="sidebar-link products-link">
                    <span>üì¶</span>
                    <span>Products</span>
                </a>
                <a href="categories.html" class="sidebar-link categories-link active">
                    <span>üìÇ</span>
                    <span>Categories</span>
                </a>
                <a href="orders.html" class="sidebar-link orders-link">
                    <span>üõí</span>
                    <span>Orders</span>
                </a>
                <a href="content.html" class="sidebar-link content-link">
                    <span>‚úèÔ∏è</span>
                    <span>Content</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8">
            <h2 class="text-3xl font-bold mb-8 text-gray-800">Categories Management</h2>

            <!-- Add Category Button -->
            <button onclick="openCategoryModal()" class="mb-6 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                + Add New Category
            </button>

            <!-- Categories Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div id="categories-container" class="col-span-full">
                    <p class="text-center text-gray-500 py-8">Loading categories...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Category Modal -->
    <div id="category-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="px-6 py-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold" id="modal-title">Add New Category</h3>
                <button onclick="closeCategoryModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <form id="category-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Category Name *</label>
                        <input type="text" id="category-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                        <textarea id="category-description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Category Image URL</label>
                        <input type="url" id="category-image" placeholder="https://example.com/image.jpg" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Display Order</label>
                        <input type="number" id="category-order" value="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </form>
            </div>
            <div class="px-6 py-4 border-t bg-gray-50 flex gap-3">
                <button onclick="closeCategoryModal()" class="flex-1 px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg transition">
                    Cancel
                </button>
                <button onclick="saveCategory()" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition">
                    Save Category
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

    <script>
        let allCategories = [];
        let currentCategoryId = null;

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `px-4 py-3 rounded shadow-lg text-white ${
                type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'
            }`;
            toast.textContent = message;
            document.getElementById('toast-container').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('admin_token');
                window.location.href = '/admin/login.html';
            }
        }

        async function loadCategories() {
            try {
                const response = await fetch(apiUrl('/api/admin/categories'));
                if (!response.ok) throw new Error('Failed to fetch categories');
                allCategories = await response.json();
                renderCategories();
            } catch (error) {
                console.error('Error loading categories:', error);
                showToast('Error loading categories', 'error');
                document.getElementById('categories-container').innerHTML = '<p class="text-center text-red-500">Error loading categories</p>';
            }
        }

        function renderCategories() {
            const container = document.getElementById('categories-container');
            
            if (allCategories.length === 0) {
                container.innerHTML = '<p class="col-span-full text-center text-gray-500 py-8">No categories found. Create one to get started!</p>';
                return;
            }

            container.innerHTML = allCategories.map(category => `
                <div class="bg-white rounded-lg shadow hover:shadow-lg transition overflow-hidden">
                    ${category.image_url ? `<img src="${category.image_url}" alt="${category.name}" class="w-full h-48 object-cover">` : `<div class="w-full h-48 bg-gradient-to-r from-blue-400 to-orange-400 flex items-center justify-center"><span class="text-white text-3xl">üìÇ</span></div>`}
                    <div class="p-4">
                        <h3 class="font-bold text-lg mb-2">${category.name}</h3>
                        ${category.description ? `<p class="text-gray-600 text-sm mb-3 line-clamp-2">${category.description}</p>` : ''}
                        <div class="mb-3 text-xs text-gray-500">Display Order: ${category.display_order || 0}</div>
                        <div class="flex gap-2">
                            <button onclick="editCategory('${category.id}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded transition text-sm font-semibold">
                                Edit
                            </button>
                            <button onclick="deleteCategory('${category.id}')" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded transition text-sm font-semibold">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openCategoryModal() {
            currentCategoryId = null;
            document.getElementById('modal-title').textContent = 'Add New Category';
            document.getElementById('category-form').reset();
            document.getElementById('category-order').value = 0;
            document.getElementById('category-modal').classList.remove('hidden');
        }

        function closeCategoryModal() {
            document.getElementById('category-modal').classList.add('hidden');
            currentCategoryId = null;
        }

        async function editCategory(categoryId) {
            const category = allCategories.find(c => c.id === categoryId);
            if (!category) return;

            currentCategoryId = categoryId;
            document.getElementById('modal-title').textContent = 'Edit Category';
            document.getElementById('category-name').value = category.name;
            document.getElementById('category-description').value = category.description || '';
            document.getElementById('category-image').value = category.image_url || '';
            document.getElementById('category-order').value = category.display_order || 0;
            
            document.getElementById('category-modal').classList.remove('hidden');
        }

        async function saveCategory() {
            const name = document.getElementById('category-name').value;
            const description = document.getElementById('category-description').value;
            const imageUrl = document.getElementById('category-image').value;
            const displayOrder = parseInt(document.getElementById('category-order').value) || 0;

            if (!name) {
                showToast('Please enter a category name', 'error');
                return;
            }

            try {
                const method = currentCategoryId ? 'PUT' : 'POST';
                const body = currentCategoryId 
                    ? { id: currentCategoryId, name, description, image_url: imageUrl, display_order: displayOrder }
                    : { name, description, image_url: imageUrl, display_order: displayOrder };

                const response = await fetch(apiUrl('/api/admin/categories'), {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!response.ok) throw new Error('Failed to save category');

                const savedCategory = await response.json();
                
                if (currentCategoryId) {
                    const idx = allCategories.findIndex(c => c.id === currentCategoryId);
                    if (idx !== -1) allCategories[idx] = savedCategory;
                } else {
                    allCategories.push(savedCategory);
                }

                closeCategoryModal();
                renderCategories();
                showToast(currentCategoryId ? 'Category updated successfully' : 'Category added successfully');
            } catch (error) {
                console.error('Error saving category:', error);
                showToast('Error saving category', 'error');
            }
        }

        async function deleteCategory(categoryId) {
            if (!confirm('Are you sure you want to delete this category?')) return;

            try {
                const response = await fetch(`/api/admin/categories?id=${categoryId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete category');

                allCategories = allCategories.filter(c => c.id !== categoryId);
                renderCategories();
                showToast('Category deleted successfully');
            } catch (error) {
                console.error('Error deleting category:', error);
                showToast('Error deleting category', 'error');
            }
        }

        window.addEventListener('DOMContentLoaded', loadCategories);
    </script>
</body>
</html>